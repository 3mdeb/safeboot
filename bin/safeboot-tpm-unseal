#!/bin/sh -x
# Unseal the key from the TPM, if possible, using direct access
# since there is no resource manager.
#
# Otherwise fall back to the user's recovery key.

PCRS='sha256:0,2,5,7,14'
HANDLE=0x81000000
export TPM2TSSENGINE_TCTI="device:/dev/tpmrm0"

echo >&2 "---- TPM PCRs ----" 
/usr/bin/tpm2_pcrread >&2 \
	'sha256:0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16' \

echo >&2 "---- Attempting TPM unseal ----" 
if /usr/bin/tpm2_unseal \
	--object-context $HANDLE \
	--auth pcr:"$PCRS" \
; then \
	# ensure that a local attacker can't re-read the key from the TPM
	# by setting pcr 14 to "postboot"
	echo >&2 "---- Extending PCR14 ----"
	/usr/bin/tpm2_pcrextend >&2 \
		14:sha256=35675e73484c1191b3c0eabe782d8634d35f17fdf632f73cd5360c1bcb133855

else
	# the key was not unsealed; ask the user for it
	/lib/cryptsetup/askpass \
		"Recovery key for $CRYPTTAB_SOURCE ($CRYPTTAB_NAME): "
fi
